import{world,system,BlockPermutation,ItemStack,BlockType}from"@minecraft/server";class AsyncQueue{#stack=[];#index=0;#taskPerTick;constructor(taskPerTick){this.#taskPerTick=Math.abs(taskPerTick)||1}get length(){return this.#stack.length}#execute(index){this.#stack[index]();this.#stack[index]=null}reset(){this.#stack=[];this.#index=0}update(){let max=n=>Math.min(n+this.#taskPerTick,this.length);for(let i=this.#index;this.#index<max(i);this.#index++){this.#execute(this.#index)}if(this.#index==this.length)this.reset()}push(func){if(typeof func!="function")return null;return new Promise((resolve,reject)=>{this.#stack.push(()=>{try{resolve(func())}catch(error){reject(error)}})})}}class VeinMiner{static#queue=new AsyncQueue;static init(speed){this.#queue=new AsyncQueue(speed)}static reset(){this.#queue.reset()}static update(){this.#queue.update()}static#cordString(x,y,z){return[x,y,z].join(" ")}static#destroyBlock(dimension,x,y,z){let cord=this.#cordString(x,y,z);return dimension.runCommandAsync(`setblock ${cord} air [] destroy`)}static mine(dimension,x,y,z,types,data){let cord=this.#cordString(x,y,z);if(!data){data={};Object.assign(data,{visited:{}})}let getBlockType=(x,y,z)=>dimension.getBlock({x:x,y:y,z:z})?.type.id;let isType=type=>type&&types.includes(type);let recurser=([x,y,z])=>isType(getBlockType(x,y,z))?this.mine(dimension,x,y,z,types,data):null;let context=this;return this.#queue.push(async()=>{if(data.visited[cord])return"visited";data.visited[cord]=true;let type=getBlockType(x,y,z);if(!isType(type))return"no type";await this.#destroyBlock(dimension,x,y,z);await Promise.all([[x+1,y,z],[x-1,y,z],[x,y+1,z],[x,y-1,z],[x,y,z+1],[x,y,z-1],[x+1,y-1,z],[x-1,y-1,z],[x,y-1,z+1],[x,y-1,z-1],[x+1,y+1,z],[x-1,y+1,z],[x,y+1,z+1],[x,y+1,z-1],[x+1,y,z+1],[x-1,y,z-1],[x-1,y,z+1],[x+1,y,z-1],[x+1,y+1,z-1],[x-1,y-1,z+1],[x+1,y+1,z+1],[x-1,y-1,z-1],[x+1,y-1,z-1],[x+1,y-1,z+1],[x-1,y+1,z+1]].map(recurser));return"done"})}}system.runInterval(()=>{try{VeinMiner.update()}catch(e){}});let shovels=["minecraft:diamond_shovel","minecraft:iron_shovel","minecraft:golden_shovel","minecraft:netherite_shovel","minecraft:wooden_shovel","minecraft:stone_shovel"];let axes=["minecraft:diamond_axe","minecraft:iron_axe","minecraft:golden_axe","minecraft:netherite_axe","minecraft:wooden_axe","minecraft:stone_axe"];let woods=["minecraft:cherry_log","minecraft:spruce_log","minecraft:oak_log","minecraft:jungle_log","minecraft:dark_oak_log","minecraft:acacia_log","minecraft:birch_log","minecraft:mangrove_log","minecraft:crimson_stem","minecraft:warped_stem"];let falls=["minecraft:gravel"];const pickaxes=[{type:"minecraft:netherite_pickaxe",ores:["minecraft:deepslate_emerald_ore","minecraft:deepslate_copper_ore","minecraft:deepslate_coal_ore","minecraft:deepslate_lapis_ore","minecraft:deepslate_diamond_ore","minecraft:deepslate_gold_ore","minecraft:deepslate_iron_ore","minecraft:quartz_ore","minecraft:nether_gold_ore","minecraft:lapis_ore","minecraft:copper_ore","minecraft:coal_ore","minecraft:iron_ore","minecraft:diamond_ore","minecraft:gold_ore","minecraft:emerald_ore","minecraft:ancient_debris"]},{type:"minecraft:diamond_pickaxe",ores:["minecraft:deepslate_emerald_ore","minecraft:deepslate_copper_ore","minecraft:deepslate_coal_ore","minecraft:deepslate_lapis_ore","minecraft:deepslate_diamond_ore","minecraft:deepslate_gold_ore","minecraft:deepslate_iron_ore","minecraft:quartz_ore","minecraft:nether_gold_ore","minecraft:lapis_ore","minecraft:copper_ore","minecraft:coal_ore","minecraft:iron_ore","minecraft:diamond_ore","minecraft:gold_ore","minecraft:emerald_ore","minecraft:ancient_debris"]},{type:"minecraft:iron_pickaxe",ores:["minecraft:deepslate_emerald_ore","minecraft:deepslate_copper_ore","minecraft:deepslate_coal_ore","minecraft:deepslate_lapis_ore","minecraft:deepslate_diamond_ore","minecraft:deepslate_gold_ore","minecraft:deepslate_iron_ore","minecraft:quartz_ore","minecraft:nether_gold_ore","minecraft:copper_ore","minecraft:lapis_ore","minecraft:coal_ore",,"minecraft:emerald_ore","minecraft:iron_ore","minecraft:diamond_ore","minecraft:gold_ore"]},{type:"minecraft:stone_pickaxe",ores:["minecraft:deepslate_copper_ore","minecraft:deepslate_coal_ore","minecraft:deepslate_lapis_ore","minecraft:deepslate_iron_ore","minecraft:quartz_ore","minecraft:nether_gold_ore","minecraft:copper_ore","minecraft:lapis_ore","minecraft:coal_ore","minecraft:iron_ore"]},{type:"minecraft:golden_pickaxe",ores:["minecraft:deepslate_coal_ore","minecraft:quartz_ore","minecraft:nether_gold_ore","minecraft:coal_ore"]},{type:"minecraft:wooden_pickaxe",ores:["minecraft:deepslate_coal_ore","minecraft:quartz_ore","minecraft:nether_gold_ore","minecraft:coal_ore"]}];world.beforeEvents.playerBreakBlock.subscribe(async eventData=>{const{player,block,brokenBlockPermutation}=eventData;let{dimension}=player;let{x,y,z}=block.location;const blockType=BlockPermutation.resolve(block.typeId).type.id;let inv=player.getComponent("minecraft:inventory").container;const item=inv.getItem(player.selectedSlot);const pickaxe=pickaxes.find(pickaxe=>pickaxe.type===item.typeId);const blocksToCheck=[{dx:0,dy:1,dz:0},{dx:0,dy:-1,dz:0},{dx:-1,dy:0,dz:0},{dx:1,dy:0,dz:0},{dx:0,dy:0,dz:1},{dx:0,dy:0,dz:-1},{dx:-1,dy:1,dz:0},{dx:1,dy:1,dz:0},{dx:-1,dy:1,dz:1},{dx:1,dy:1,dz:1},{dx:-1,dy:-1,dz:0},{dx:1,dy:-1,dz:0},{dx:-1,dy:-1,dz:1},{dx:1,dy:-1,dz:1},{dx:0,dy:1,dz:-1},{dx:0,dy:1,dz:1},{dx:0,dy:-1,dz:-1},{dx:0,dy:-1,dz:1},{dx:-1,dy:0,dz:-1},{dx:-1,dy:0,dz:1},{dx:1,dy:0,dz:-1},{dx:1,dy:0,dz:1}];if(pickaxe&&pickaxe.ores.includes(blockType)){const ored=pickaxe.ores.find(ore=>blockType.includes(ore));let matchingX,matchingY,matchingZ;for(const{dx,dy,dz}of blocksToCheck){const block=dimension.getBlock({x:x+dx,y:y+dy,z:z+dz});if(block.typeId===ored){matchingX=x+dx;matchingY=y+dy;matchingZ=z+dz;break}}if(player.isSneaking==true&&ored&&item.getLore()=="§r§7Vein Miner II"){VeinMiner.init(15);if(block.typeId!=ored)return;try{await VeinMiner.mine(dimension,matchingX,matchingY,matchingZ,[ored])}catch(e){}}else if(player.isSneaking==true&&item.getLore()=="§r§7Vein Miner I"&&ored){VeinMiner.init(1);if(block.typeId!=ored)return;try{await VeinMiner.mine(dimension,matchingX,matchingY,matchingZ,[ored])}catch(e){}}}const axe=axes.find(axe=>axe==item.typeId);if(player.isSneaking==true&&axe&&item.getLore()=="§r§7Vein Miner II"){VeinMiner.init(15);for(let wood of woods){let matchingX,matchingY,matchingZ;for(const{dx,dy,dz}of blocksToCheck){const block=dimension.getBlock({x:x+dx,y:y+dy,z:z+dz});if(block.typeId===wood){matchingX=x+dx;matchingY=y+dy;matchingZ=z+dz;break}}if(block.typeId!=wood)continue;try{await VeinMiner.mine(dimension,matchingX,matchingY,matchingZ,[wood]);break}catch(e){}}}else if(player.isSneaking==true&&item.getLore()=="§r§7Vein Miner I"&&axe){VeinMiner.init(1);for(let wood of woods){let matchingX,matchingY,matchingZ;for(const{dx,dy,dz}of blocksToCheck){const block=dimension.getBlock({x:x+dx,y:y+dy,z:z+dz});if(block.typeId===wood){matchingX=x+dx;matchingY=y+dy;matchingZ=z+dz;break}}if(block.typeId!=wood)continue;try{await VeinMiner.mine(dimension,matchingX,matchingY,matchingZ,[wood]);break}catch(e){}}}const shovel=shovels.find(shovel=>shovel==item.typeId);if(player.isSneaking==true&&shovel&&item.getLore()=="§r§7Vein Miner II"){VeinMiner.init(15);for(let fall of falls){let matchingX,matchingY,matchingZ;for(const{dx,dy,dz}of blocksToCheck){const block=dimension.getBlock({x:x+dx,y:y+dy,z:z+dz});if(block.typeId===fall){matchingX=x+dx;matchingY=y+dy;matchingZ=z+dz;break}}if(block.typeId!=fall)continue;try{await VeinMiner.mine(dimension,matchingX,matchingY,matchingZ,[fall]);break}catch(e){}}}else if(player.isSneaking==true&&item.getLore()=="§r§7Vein Miner I"&&shovel){VeinMiner.init(1);for(let fall of falls){let matchingX,matchingY,matchingZ;for(const{dx,dy,dz}of blocksToCheck){const block=dimension.getBlock({x:x+dx,y:y+dy,z:z+dz});if(block.typeId===fall){matchingX=x+dx;matchingY=y+dy;matchingZ=z+dz;break}}if(block.typeId!=fall)continue;try{await VeinMiner.mine(dimension,matchingX,matchingY,matchingZ,[fall]);break}catch(e){}}}});world.beforeEvents.chatSend.subscribe(data=>{if(data.message.startsWith("!"))return data.cancel=true});world.beforeEvents.chatSend.subscribe(data=>{try{let{sender,message}=data;system.run(()=>{const args=message.trim().split(/\s+/);let inv=sender.getComponent("minecraft:inventory").container;const item=inv.getItem(sender.selectedSlot);if(message.startsWith("!enchant")&&!item)return sender.sendMessage("§cPlease hold a Tool"),sender.runCommandAsync("playsound random.glass");const axe=axes.find(axe=>axe==item.typeId);const pickaxe=pickaxes.find(pickaxe=>pickaxe.type==item.typeId);const shovel=shovels.find(shovel=>shovel==item.typeId);if(message.startsWith("!enchant")&&!axe&&!pickaxe&&!shovel)return sender.sendMessage("§cPlease hold a Tool"),sender.runCommandAsync("playsound random.glass");if(axe){let itemm=new ItemStack(`${axe}`,1);if(message.startsWith("!enchant")){if(!args[0]||!args[1])return sender.sendMessage("§cPlease enter a value"),sender.runCommandAsync("playsound random.glass");if(args[1]=="1"&&sender.level>=10){if(item.getLore()=="§r§7Vein Miner I")return sender.sendMessage("§cYou alread have this enchantment"),sender.runCommandAsync("playsound random.glass");sender.runCommandAsync(`xp -10L @s`);itemm.setLore([""]);itemm.setLore(["§r§7Vein Miner I"]);inv.setItem(sender.selectedSlot,itemm);sender.runCommandAsync("playsound random.levelup")}else if(args[1]!="2"){sender.sendMessage("§cYou don't have enough level. 10L needed");sender.runCommandAsync("playsound random.glass")}if(args[1]=="2"&&sender.level>=20){if(item.getLore()=="§r§7Vein Miner II")return sender.sendMessage("§cYou alread have this enchantment"),sender.runCommandAsync("playsound random.glass");sender.runCommandAsync(`xp -20L @s`);itemm.setLore([""]);itemm.setLore(["§r§7Vein Miner II"]);inv.setItem(sender.selectedSlot,itemm);sender.runCommandAsync("playsound random.levelup")}else if(args[1]&&args[1]!="1"){sender.sendMessage("§cYou don't have enough level. 20L needed");sender.runCommandAsync("playsound random.glass")}}}if(pickaxe){let itemmd=new ItemStack(`${pickaxe.type}`,1);if(message.startsWith("!enchant")){if(!args[0]||!args[1])return sender.sendMessage("§cPlease enter a value"),sender.runCommandAsync("playsound random.glass");if(args[1]=="1"&&sender.level>=10){if(item.getLore()=="§r§7Vein Miner I")return sender.sendMessage("§cYou alread have this enchantment"),sender.runCommandAsync("playsound random.glass");sender.runCommandAsync(`xp -10L @s`);itemmd.setLore([""]);itemmd.setLore(["§r§7Vein Miner I"]);inv.setItem(sender.selectedSlot,itemmd);sender.runCommandAsync("playsound random.levelup")}else if(args[1]!="2"){sender.sendMessage("§cYou don't have enough level. 10L needed");sender.runCommandAsync("playsound random.glass")}if(args[1]=="2"&&sender.level>=20){if(item.getLore()=="§r§7Vein Miner II")return sender.sendMessage("§cYou alread have this enchantment"),sender.runCommandAsync("playsound random.glass");sender.runCommandAsync(`xp -20L @s`);itemmd.setLore([""]);itemmd.setLore(["§r§7Vein Miner II"]);inv.setItem(sender.selectedSlot,itemmd);sender.runCommandAsync("playsound random.levelup")}else if(args[1]&&args[1]!="1"){sender.sendMessage("§cYou don't have enough level. 20L needed");sender.runCommandAsync("playsound random.glass")}}}if(shovel){let itemmd=new ItemStack(`${shovel}`,1);if(message.startsWith("!enchant")){if(!args[0]||!args[1])return sender.sendMessage("§cPlease enter a value"),sender.runCommandAsync("playsound random.glass");if(args[1]=="1"&&sender.level>=10){if(item.getLore()=="§r§7Vein Miner I")return sender.sendMessage("§cYou alread have this enchantment"),sender.runCommandAsync("playsound random.glass");sender.runCommandAsync(`xp -10L @s`);itemmd.setLore([""]);itemmd.setLore(["§r§7Vein Miner I"]);inv.setItem(sender.selectedSlot,itemmd);sender.runCommandAsync("playsound random.levelup")}else if(args[1]!="2"){sender.sendMessage("§cYou don't have enough level. 10L needed");sender.runCommandAsync("playsound random.glass")}if(args[1]=="2"&&sender.level>=20){if(item.getLore()=="§r§7Vein Miner II")return sender.sendMessage("§cYou alread have this enchantment"),sender.runCommandAsync("playsound random.glass");sender.runCommandAsync(`xp -20L @s`);itemmd.setLore([""]);itemmd.setLore(["§r§7Vein Miner II"]);inv.setItem(sender.selectedSlot,itemmd);sender.runCommandAsync("playsound random.levelup")}else if(args[1]&&args[1]!="1"){sender.sendMessage("§cYou don't have enough level. 20L needed");sender.runCommandAsync("playsound random.glass")}}}})}catch(e){}});